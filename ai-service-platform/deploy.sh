#!/bin/bash
set -e

# =====================================================================
# üöÄ BALT-SET.RU DEPLOYMENT SCRIPT
# =====================================================================

echo "=================================================="
echo "üöÄ BALT-SET.RU –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï"
echo "=================================================="

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
CURRENT_DIR=$(pwd)
print_status "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $CURRENT_DIR"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–µ
if [[ "$CURRENT_DIR" != *"ai-service-platform"* ]]; then
    print_error "–°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∏–∑ –ø–∞–ø–∫–∏ ai-service-platform"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_ROOT=$(dirname "$CURRENT_DIR")
print_status "–ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_ROOT"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ Git
if ! command -v git &> /dev/null; then
    print_error "Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

print_success "Git –Ω–∞–π–¥–µ–Ω"

# =====================================================================
# –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Git
# =====================================================================
print_status "–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Git..."

cd "$PROJECT_ROOT"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if [[ -n $(git status --porcelain) ]]; then
    print_warning "–ù–∞–π–¥–µ–Ω—ã –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    git status --porcelain
    echo ""
    read -p "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git add .
        read -p "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: " commit_msg
        if [[ -z "$commit_msg" ]]; then
            commit_msg="üîÑ Auto-commit: $(date)"
        fi
        git commit -m "$commit_msg"
        print_success "–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
    else
        print_warning "–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
    fi
else
    print_success "–ù–µ—Ç –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π"
fi

# =====================================================================
# –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
# =====================================================================
print_status "–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π remote
REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")

if [[ "$REMOTE_URL" != *"Heallshoking/balt-set.ru"* ]]; then
    print_warning "–¢–µ–∫—É—â–∏–π remote: $REMOTE_URL"
    print_warning "–û–∂–∏–¥–∞–µ—Ç—Å—è: https://github.com/Heallshoking/balt-set.ru.git"
    
    echo ""
    read -p "–û–±–Ω–æ–≤–∏—Ç—å remote URL? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git remote remove origin 2>/dev/null || true
        git remote add origin https://github.com/Heallshoking/balt-set.ru.git
        print_success "Remote –æ–±–Ω–æ–≤–ª–µ–Ω"
    fi
else
    print_success "Remote –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: $REMOTE_URL"
fi

# =====================================================================
# –®–ê–ì 3: –ü—É—à –≤ GitHub
# =====================================================================
print_status "–®–∞–≥ 3: Push –≤ GitHub..."

# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤–µ—Ç–∫–∞ main
git branch -M main 2>/dev/null || true

# –í—ã–ø–æ–ª–Ω–∏—Ç—å push
print_status "–í—ã–ø–æ–ª–Ω—è—é git push origin main..."
if git push -u origin main; then
    print_success "‚úÖ –§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ GitHub! –ß–µ—Ä–µ–∑ 3-5 –º–∏–Ω—É—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –Ω–∞ Timeweb"
else
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ push. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞"
    exit 1
fi

# =====================================================================
# –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
# =====================================================================
print_status "–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
if [[ "$PROJECT_ROOT" == *"/Projects/Github/balt-set.ru" ]]; then
    print_success "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
else
    print_warning "–ü—Ä–æ–µ–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–∞–ø–∫–µ"
    print_warning "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤: /Users/user/Documents/Projects/Github/balt-set.ru"
fi

# =====================================================================
# –®–ê–ì 5: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
# =====================================================================
echo ""
echo "=================================================="
echo "üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo "=================================================="
echo ""
echo "1. ${BLUE}–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ–ø–ª–æ–π –Ω–∞ Timeweb:${NC}"
echo "   –û—Ç–∫—Ä–æ–π—Ç–µ: https://timeweb.cloud/my/apps"
echo "   –ù–∞–π–¥–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 'ai-service-platform'"
echo "   –î–æ–ª–∂–Ω–æ –Ω–∞—á–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
echo ""
echo "2. ${BLUE}–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–∞:${NC}"
echo "   –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: https://app.balt-set.ru/"
echo "   –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: https://app.balt-set.ru/admin"
echo "   –ö–∞–±–∏–Ω–µ—Ç –º–∞—Å—Ç–µ—Ä–∞: https://app.balt-set.ru/master"
echo ""
echo "3. ${BLUE}–ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:${NC}"
echo "   Swagger UI: https://app.balt-set.ru/docs"
echo ""
echo "4. ${BLUE}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:${NC}"
echo "   –õ–æ–≥–∏: https://timeweb.cloud/my/apps/ai-service-platform/logs"
echo ""
echo "=================================================="
echo "‚úÖ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "=================================================="
echo ""
echo "üí° –°–æ–≤–µ—Ç—ã:"
echo "   ‚Ä¢ –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞"
echo "   ‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ —á–µ—Ä–µ–∑ 3-5 –º–∏–Ω—É—Ç"
echo "   ‚Ä¢ –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Timeweb"

# =====================================================================
# –®–ê–ì 6: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# =====================================================================
echo ""
read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ–ø–ª–æ—è? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    print_status "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)..."
    
    # –ü—Ä–æ—Å—Ç–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞
    while true; do
        if curl -s --head https://app.balt-set.ru/ | head -n 1 | grep "200" > /dev/null; then
            print_success "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω!"
            break
        else
            print_status "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–ø–ª–æ—è..."
            sleep 30
        fi
    done
fi

print_success "üéâ –í—Å—ë –≥–æ—Ç–æ–≤–æ!"
